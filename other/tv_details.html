<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="tv_details.css" />
    <title>TV Show Details</title>
</head>
<body>
    <div id="head">
        <img class="logo" src="../img/LOGO.png" alt="Logo" />
    </div>
    <div id="background-container"></div>
    <div id="tv-details-container">
        <div class="season-episode-selector" id="season-episode-selector">
            <div class="custom-dropdown" id="seasonDropdownContainer">
                <button class="dropdown-button" id="seasonDropdownButton">Select Season</button>
                <div class="dropdown-menu" id="seasonDropdownMenu"></div>
            </div>

            <div class="custom-dropdown" id="episodeDropdownContainer">
                <button class="dropdown-button" id="episodeDropdownButton">Select Episode</button>
                <div class="dropdown-menu" id="episodeDropdownMenu"></div>
            </div>

            <img id="playButton" src="../img/play.png" alt="Play Trailer" />
        </div>
        <!-- TV show details will be dynamically added here -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const tvShowId = urlParams.get('id');

            if (tvShowId) {
                fetchTVShowDetails(tvShowId)
                    .then(displayTVShowDetails)
                    .catch((error) => console.error('Error fetching TV show details:', error));
            } else {
                console.error('TV show ID not found in the URL.');
            }
        });

        async function fetchTVShowDetails(tvShowId) {
            const apiKey = '0e1a4d969bc043a99a76f16143ed629b';
            const baseUrl = 'https://api.themoviedb.org/3';

            try {
                const response = await fetch(`${baseUrl}/tv/${tvShowId}?api_key=${apiKey}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch TV show details');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                throw error;
            }
        }

        function displayTVShowDetails(tvShowDetails) {
            const tvDetailsContainer = document.getElementById('tv-details-container');
            const backgroundContainer = document.getElementById('background-container');

            if (!tvDetailsContainer || !backgroundContainer) {
                console.error('TV show details or background container not found.');
                return;
            }

            // Clear previous details content only (keep dropdowns)
            const existingDetails = tvDetailsContainer.querySelectorAll('h1, p, img.tv-show-cover');
            existingDetails.forEach(el => el.remove());

            const nameElement = document.createElement('h1');
            nameElement.textContent = tvShowDetails.name;

            const firstAirDateElement = document.createElement('p');
            firstAirDateElement.textContent = `First Air Date: ${tvShowDetails.first_air_date}`;

            const overviewElement = document.createElement('p');
            overviewElement.textContent = `Overview: ${tvShowDetails.overview}`;

            const voteAverageElement = document.createElement('p');
            voteAverageElement.textContent = `Vote Average: ${tvShowDetails.vote_average}`;

            const tvShowCoverElement = document.createElement('img');
            tvShowCoverElement.src = `https://image.tmdb.org/t/p/w500${tvShowDetails.poster_path}`;
            tvShowCoverElement.alt = tvShowDetails.name;
            tvShowCoverElement.classList.add('tv-show-cover');

            // VisionOS dropdowns
            const seasonDropdownMenu = document.getElementById('seasonDropdownMenu');
            const seasonDropdownButton = document.getElementById('seasonDropdownButton');
            const episodeDropdownMenu = document.getElementById('episodeDropdownMenu');
            const episodeDropdownButton = document.getElementById('episodeDropdownButton');

            let selectedSeason = 1;

            // Populate season dropdown
            seasonDropdownMenu.innerHTML = '';
            for (let i = 1; i <= tvShowDetails.number_of_seasons; i++) {
                const seasonOption = document.createElement('div');
                seasonOption.textContent = `Season ${i}`;
                seasonOption.addEventListener('click', () => {
                    seasonDropdownButton.textContent = `Season ${i}`;
                    selectedSeason = i;
                    populateEpisodesDropdownVision(tvShowDetails, selectedSeason);
                });
                seasonDropdownMenu.appendChild(seasonOption);
            }

            // Populate initial episodes
            populateEpisodesDropdownVision(tvShowDetails, selectedSeason);

            // Play button event
            const playButton = document.getElementById('playButton');
            playButton.addEventListener('click', () => {
                const selectedEpisodeText = episodeDropdownButton.textContent;
                const selectedEpisode = parseInt(selectedEpisodeText.replace('Episode ', ''));
                window.location.href = `tv_play.html?id=${tvShowDetails.id}&season=${selectedSeason}&episode=${selectedEpisode}`;
            });

            // Append show details
            tvDetailsContainer.appendChild(tvShowCoverElement);
            tvDetailsContainer.appendChild(nameElement);
            tvDetailsContainer.appendChild(firstAirDateElement);
            tvDetailsContainer.appendChild(overviewElement);
            tvDetailsContainer.appendChild(voteAverageElement);

            // Background image
            backgroundContainer.style.backgroundImage = `url('https://image.tmdb.org/t/p/w1280${tvShowDetails.backdrop_path}')`;

            // Close dropdowns on click outside
            document.addEventListener('click', (event) => {
                if (!seasonDropdownMenu.contains(event.target) && event.target !== seasonDropdownButton) {
                    seasonDropdownMenu.style.display = 'none';
                }
                if (!episodeDropdownMenu.contains(event.target) && event.target !== episodeDropdownButton) {
                    episodeDropdownMenu.style.display = 'none';
                }
            });

            // Toggle menus on button click
            seasonDropdownButton.addEventListener('click', (e) => {
                e.stopPropagation();
                seasonDropdownMenu.style.display = seasonDropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
            episodeDropdownButton.addEventListener('click', (e) => {
                e.stopPropagation();
                episodeDropdownMenu.style.display = episodeDropdownMenu.style.display === 'block' ? 'none' : 'block';
            });
        }

        function populateEpisodesDropdownVision(tvShowDetails, selectedSeason) {
            const episodeDropdownMenu = document.getElementById('episodeDropdownMenu');
            const episodeDropdownButton = document.getElementById('episodeDropdownButton');

            episodeDropdownMenu.innerHTML = '';

            const season = tvShowDetails.seasons.find(s => s.season_number === selectedSeason);

            if (season) {
                for (let i = 1; i <= season.episode_count; i++) {
                    const episodeOption = document.createElement('div');
                    episodeOption.textContent = `Episode ${i}`;
                    episodeOption.addEventListener('click', () => {
                        episodeDropdownButton.textContent = `Episode ${i}`;
                        episodeDropdownMenu.style.display = 'none';
                    });
                    episodeDropdownMenu.appendChild(episodeOption);
                }
            }

            // Reset episode button when season changes
            episodeDropdownButton.textContent = 'Select Episode';
        }
    </script>
</body>
</html>
